name: Generate Documentation for Vulkan Project
on:
  push:
    branches: [main]
    paths: ['**.h','**.cpp', 'CMakeLists.txt', '**.cmake', '**.md']

jobs:
  generate-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ï¼Œæœ‰åŠ©äºåˆ†æé¡¹ç›®ç»“æ„
      
      - name: Setup project context
        run: |
          # å®‰è£…Vulkanç›¸å…³çš„å¼€å‘å·¥å…·ï¼ˆå¦‚æœéœ€è¦ï¼‰
          sudo apt-get update
          sudo apt-get install -y vulkan-validationlayers vulkan-tools
          # æ˜¾ç¤ºé¡¹ç›®ç»“æ„
          find . -name "*.cpp" -o -name "*.h" -o -name "CMakeLists.txt" | head -20
          echo "=== Project Structure ==="
          tree -I 'build|.git' -L 3 || ls -la
      
      - name: Initialize Vulkan project analysis
        uses: iflow-ai/iflow-cli-action@v2.1.0
        with:
          prompt: |
            You are analyzing a Vulkan graphics application project. Please analyze:
            
            1. Project structure and build system (CMake)
            2. Vulkan initialization and rendering pipeline
            3. Shader management and resource handling
            4. Platform abstraction layers
            5. ImGui integration (if present)
            
            Focus on understanding the Vulkan-specific architecture and components.
            Provide a high-level overview of the codebase structure.
          api_key: ${{ secrets.IFLOW_API_KEY }}
          model: "qwen3-coder-plus"  # æ›´é€‚åˆä»£ç åˆ†æ
          timeout: "300"
          working_directory: "."
          precmd: |
            # è®¾ç½®åŸºæœ¬çš„å¼€å‘ç¯å¢ƒ
            git config --global user.email "github-actions[bot]@users.noreply.github.com"
            git config --global user.name "github-actions[bot]"
      
      - name: Generate comprehensive Vulkan documentation
        uses: iflow-ai/iflow-cli-action@v2.1.0
        with:
          prompt: |
            ## Role: Senior Graphics Engineer
            
            Generate comprehensive technical documentation for this Vulkan C++ project.
            
            ## Documentation Structure Requirements:
            
            ### 1. Project Overview
            - High-level architecture description
            - Build system explanation (CMake)
            - Dependencies and external libraries
            
            ### 2. Vulkan-Specific Documentation
            - **Initialization Sequence**: VkInstance, VkDevice, swap chain setup
            - **Rendering Pipeline**: Graphics pipeline creation and management
            - **Resource Management**: Buffers, images, descriptor sets
            - **Shader System**: GLSL shaders compilation and usage
            - **Synchronization**: Fences, semaphores, barriers
            
            ### 3. Component Documentation
            - For each major class/component:
              * Purpose and responsibilities
              * Key methods and their functions
              * Vulkan resource lifecycle management
              * Threading considerations (if any)
            
            ### 4. API Reference
            - Key public interfaces
            - Important data structures
            - Configuration options
            
            ### 5. Usage Examples
            - Basic setup and initialization
            - Rendering a simple scene
            - Adding new features
            
            ### 6. Best Practices & Guidelines
            - Vulkan validation layer usage
            - Memory management patterns
            - Performance considerations
            - Debugging tips
            
            ## Formatting Guidelines:
            - Use proper Markdown with code blocks for C++ examples
            - Include actual code snippets from the project
            - Reference specific files and line numbers when relevant
            - Focus on Vulkan-specific patterns and idioms
            
            Generate detailed, actionable documentation that would help new developers understand and work with this Vulkan codebase.
          api_key: ${{ secrets.IFLOW_API_KEY }}
          model: "qwen3-coder-plus"
          timeout: "900"  # å¢åŠ è¶…æ—¶æ—¶é—´ï¼Œå› ä¸ºVulkané¡¹ç›®å¯èƒ½å¾ˆå¤æ‚
          working_directory: "."
        id: docs
      
      - name: Create documentation directory structure
        run: |
          mkdir -p docs/api
          mkdir -p docs/guides
          mkdir -p docs/architecture
          mkdir -p docs/examples
      
      - name: Create main documentation file
        run: |
          # åˆ›å»ºä¸»æ–‡æ¡£æ–‡ä»¶
          echo "# Vulkan Project Technical Documentation\n\n*Generated on $(date)*\n\n" > docs/OVERVIEW.md
          echo "${{ steps.docs.outputs.result }}" >> docs/OVERVIEW.md
          
          # å¦‚æœæ–‡æ¡£å¾ˆé•¿ï¼Œå¯ä»¥åˆ†å‰²æˆå¤šä¸ªæ–‡ä»¶
          # è¿™é‡Œå¯ä»¥æ·»åŠ é€»è¾‘æ¥åˆ†å‰²å¤§æ–‡æ¡£
          echo "Documentation generated successfully"
          echo "Total characters: $(wc -c < docs/OVERVIEW.md)"
      
      - name: Validate documentation
        run: |
          # æ£€æŸ¥æ–‡æ¡£æ˜¯å¦åŒ…å«å…³é”®Vulkanç›¸å…³å†…å®¹
          if grep -q -i "vulkan\|VkInstance\|VkDevice\|pipeline\|shader" docs/OVERVIEW.md; then
            echo "âœ“ Documentation contains Vulkan-specific content"
          else
            echo "âš  Warning: Documentation may lack Vulkan-specific details"
          fi
          
          # æ£€æŸ¥æ–‡æ¡£é•¿åº¦
          if [ $(wc -c < docs/OVERVIEW.md) -gt 1000 ]; then
            echo "âœ“ Documentation has substantial content"
          else
            echo "âš  Warning: Documentation seems very short"
            exit 1
          fi
      
      - name: Commit documentation
        if: success()
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: auto-generate Vulkan technical documentation"
          file_pattern: |
            docs/
            docs/**/*
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"
      
      - name: Create documentation summary
        run: |
          echo "## Documentation Generation Complete" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Generated comprehensive Vulkan project documentation" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“ Documentation saved to: docs/OVERVIEW.md" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ” Focused on Vulkan-specific architecture and patterns" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ• Generated on: $(date)" >> $GITHUB_STEP_SUMMARY
