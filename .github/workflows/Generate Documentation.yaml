name: Generate Documentation for Vulkan Project

on:
  # è‡ªåŠ¨è§¦å‘ï¼šå½“ç‰¹å®šæ–‡ä»¶æ›´æ”¹æ—¶
  push:
    branches: [main]
    paths: ['**.h','**.cpp', 'CMakeLists.txt', '**.cmake', '**.md']
  
  # æ‰‹åŠ¨è§¦å‘ï¼šä»ŽGitHubç•Œé¢æ‰‹åŠ¨è¿è¡Œ
  workflow_dispatch:
    inputs:
      documentation_scope:
        description: 'é€‰æ‹©æ–‡æ¡£ç”Ÿæˆçš„èŒƒå›´'
        required: true
        default: 'full'
        type: choice
        options:
        - 'full'
        - 'api-only'
        - 'architecture-only'
        - 'quick-overview'
      regenerate_all:
        description: 'é‡æ–°ç”Ÿæˆæ‰€æœ‰æ–‡æ¡£ï¼ˆå³ä½¿æ–‡ä»¶æœªæ›´æ”¹ï¼‰'
        required: false
        default: false
        type: boolean
      include_examples:
        description: 'åŒ…å«ä»£ç ç¤ºä¾‹'
        required: false
        default: true
        type: boolean

jobs:
  generate-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup project context
        run: |
          # å®‰è£…Vulkanç›¸å…³çš„å¼€å‘å·¥å…·ï¼ˆå¦‚æžœéœ€è¦ï¼‰
          sudo apt-get update
          sudo apt-get install -y vulkan-validationlayers vulkan-tools tree
          # æ˜¾ç¤ºé¡¹ç›®ç»“æž„
          find . -name "*.cpp" -o -name "*.h" -o -name "CMakeLists.txt" | head -20
          echo "=== Project Structure ==="
          tree -I 'build|.git' -L 3 || ls -la
          
          # è¾“å‡ºæ‰‹åŠ¨è§¦å‘å‚æ•°ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
          echo "Workflow triggered manually: ${{ github.event_name == 'workflow_dispatch' }}"
          echo "Documentation scope: ${{ github.event.inputs.documentation_scope }}"
          echo "Regenerate all: ${{ github.event.inputs.regenerate_all }}"
          echo "Include examples: ${{ github.event.inputs.include_examples }}"
      
      - name: Initialize Vulkan project analysis
        uses: iflow-ai/iflow-cli-action@v2.1.0
        with:
          prompt: |
            You are analyzing a Vulkan graphics application project. Please analyze:
            
            1. Project structure and build system (CMake)
            2. Vulkan initialization and rendering pipeline
            3. Shader management and resource handling
            4. Platform abstraction layers
            5. ImGui integration (if present)
            
            Focus on understanding the Vulkan-specific architecture and components.
            Provide a high-level overview of the codebase structure.
          api_key: ${{ secrets.IFLOW_API_KEY }}
          model: "qwen3-coder-plus"
          base_url: "https://apis.iflow.cn/v1"
          timeout: "300"
          working_directory: "."
          precmd: |
            git config --global user.email "github-actions[bot]@users.noreply.github.com"
            git config --global user.name "github-actions[bot]"
      
      - name: Generate comprehensive Vulkan documentation
        uses: iflow-ai/iflow-cli-action@v2.1.0
        with:
          prompt: |
            ## Role: Senior Graphics Engineer
            
            Generate technical documentation for this Vulkan C++ project.
            
            ## Documentation Scope: ${{ github.event.inputs.documentation_scope || 'full' }}
            ${{ github.event.inputs.documentation_scope == 'api-only' && 'Focus primarily on API reference and code-level documentation.' || '' }}
            ${{ github.event.inputs.documentation_scope == 'architecture-only' && 'Focus on high-level architecture and design patterns.' || '' }}
            ${{ github.event.inputs.documentation_scope == 'quick-overview' && 'Provide a concise overview focusing on key components.' || '' }}
            ${{ github.event.inputs.documentation_scope == 'full' && 'Generate comprehensive documentation covering all aspects.' || '' }}
            
            ${{ github.event.inputs.include_examples == 'false' && 'Skip code examples and usage guides.' || 'Include detailed code examples and usage guides.' }}
            
            ## Documentation Structure:
            
            ### 1. Project Overview
            - High-level architecture description
            - Build system explanation (CMake)
            - Dependencies and external libraries
            
            ### 2. Vulkan-Specific Documentation
            - **Initialization Sequence**: VkInstance, VkDevice, swap chain setup
            - **Rendering Pipeline**: Graphics pipeline creation and management
            - **Resource Management**: Buffers, images, descriptor sets
            - **Shader System**: GLSL shaders compilation and usage
            - **Synchronization**: Fences, semaphores, barriers
            
            ${{ github.event.inputs.documentation_scope != 'quick-overview' && '
            ### 3. Component Documentation
            - For each major class/component:
              * Purpose and responsibilities
              * Key methods and their functions
              * Vulkan resource lifecycle management
              * Threading considerations (if any)
            
            ### 4. API Reference
            - Key public interfaces
            - Important data structures
            - Configuration options
            ' || '' }}
            
            ${{ github.event.inputs.include_examples == 'true' && github.event.inputs.documentation_scope != 'quick-overview' && '
            ### 5. Usage Examples
            - Basic setup and initialization
            - Rendering a simple scene
            - Adding new features
            ' || '' }}
            
            ### 6. Best Practices & Guidelines
            - Vulkan validation layer usage
            - Memory management patterns
            - Performance considerations
            - Debugging tips
            
            ## Formatting Guidelines:
            - Use proper Markdown with code blocks for C++ examples
            - Include actual code snippets from the project
            - Reference specific files and line numbers when relevant
            - Focus on Vulkan-specific patterns and idioms
            
            Generate documentation appropriate for the selected scope.
          api_key: ${{ secrets.IFLOW_API_KEY }}
          model: "qwen3-coder-plus"
          base_url: "https://apis.iflow.cn/v1"
          timeout: ${{ github.event.inputs.documentation_scope == 'quick-overview' && '600' || '900' }}
          working_directory: "."
        id: docs
      
      - name: Create documentation directory structure
        run: |
          mkdir -p docs/api
          mkdir -p docs/guides
          mkdir -p docs/architecture
          mkdir -p docs/examples
          
          # æ ¹æ®è§¦å‘ç±»åž‹åˆ›å»ºä¸åŒçš„æ–‡ä»¶å
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            SCOPE="${{ github.event.inputs.documentation_scope }}"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            DOC_FILE="docs/VULKAN_DOCS_${SCOPE}_${TIMESTAMP}.md"
          else
            DOC_FILE="docs/VULKAN_DOCS_AUTO.md"
          fi
          echo "DOC_FILE=${DOC_FILE}" >> $GITHUB_ENV
      
      - name: Create main documentation file
        run: |
          echo "# Vulkan Project Technical Documentation" > $DOC_FILE
          echo "" >> $DOC_FILE
          echo "*Generated on $(date)*" >> $DOC_FILE
          echo "*Scope: ${{ github.event.inputs.documentation_scope || 'auto-generated' }}*" >> $DOC_FILE
          echo "*Trigger: ${{ github.event_name }}*" >> $DOC_FILE
          echo "" >> $DOC_FILE
          echo "${{ steps.docs.outputs.result }}" >> $DOC_FILE
          
          echo "Documentation generated successfully: $DOC_FILE"
          echo "Total characters: $(wc -c < $DOC_FILE)"
      
      - name: Validate documentation
        run: |
          # æ£€æŸ¥æ–‡æ¡£æ˜¯å¦åŒ…å«å…³é”®Vulkanç›¸å…³å†…å®¹
          if grep -q -i "vulkan\|VkInstance\|VkDevice\|pipeline\|shader" $DOC_FILE; then
            echo "âœ“ Documentation contains Vulkan-specific content"
          else
            echo "âš  Warning: Documentation may lack Vulkan-specific details"
          fi
          
          # æ£€æŸ¥æ–‡æ¡£é•¿åº¦
          if [ $(wc -c < $DOC_FILE) -gt 1000 ]; then
            echo "âœ“ Documentation has substantial content"
          else
            echo "âš  Warning: Documentation seems very short"
            # å¯¹äºŽæ‰‹åŠ¨è§¦å‘ï¼Œä¸å¼ºåˆ¶å¤±è´¥
            if [ "${{ github.event_name }}" = "push" ]; then
              exit 1
            fi
          fi
      
      - name: Commit documentation
        if: success()
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: |
            docs: ${{ github.event.inputs.documentation_scope && format('generate {0} Vulkan documentation', github.event.inputs.documentation_scope) || 'auto-generate Vulkan technical documentation' }}
            ${{ github.event_name == 'workflow_dispatch' && '(manual trigger)' || '' }}
          file_pattern: |
            docs/
            docs/**/*
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"
      
      - name: Create documentation summary
        run: |
          echo "## Documentation Generation Complete" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Generated Vulkan project documentation" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ Documentation saved to: $DOC_FILE" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” Scope: ${{ github.event.inputs.documentation_scope || 'full' }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ¯ Trigger: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ• Generated on: $(date)" >> $GITHUB_STEP_SUMMARY
          
          # æ˜¾ç¤ºæ–‡æ¡£é¢„è§ˆï¼ˆå‰500å­—ç¬¦ï¼‰
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Preview:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          head -c 500 $DOC_FILE >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
